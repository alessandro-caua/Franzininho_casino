<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>🎰 FRANZININHO CASINO - ROLETA RGB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { 
      font-family: 'Rajdhani', sans-serif;
      --cyan: #00ffff;
      --magenta: #ff00ff;
      --green: #00ff41;
      --red: #ff0055;
      --blue: #0080ff;
      --white: #ffffff;
      --yellow: #ffaa00;
      --dark: #0a0a0f;
    }
    body { 
      background: #0a0a0f;
      background-image: 
        repeating-linear-gradient(0deg, rgba(0, 255, 255, 0.03) 0px, transparent 1px, transparent 2px, rgba(0, 255, 255, 0.03) 3px),
        repeating-linear-gradient(90deg, rgba(0, 255, 255, 0.03) 0px, transparent 1px, transparent 2px, rgba(0, 255, 255, 0.03) 3px),
        radial-gradient(circle at 50% 50%, rgba(255, 0, 255, 0.15) 0%, transparent 50%);
      background-size: 50px 50px, 50px 50px, 100% 100%;
      min-height: 100vh;
      padding: 20px;
      color: #e0e0e0;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(transparent 50%, rgba(0, 255, 255, 0.02) 50%);
      background-size: 4px 4px;
      pointer-events: none;
      z-index: 1;
      animation: scanlines 10s linear infinite;
    }
    @keyframes scanlines {
      0% { transform: translateY(0); }
      100% { transform: translateY(4px); }
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      position: relative;
      z-index: 2;
    }
    h1 {
      font-family: 'Orbitron', monospace;
      color: var(--cyan);
      text-align: center;
      margin-bottom: 10px;
      font-size: 3.5em;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 8px;
      text-shadow: 
        0 0 10px rgba(0, 255, 255, 0.8),
        0 0 20px rgba(0, 255, 255, 0.6),
        0 0 30px rgba(0, 255, 255, 0.4),
        0 0 40px rgba(255, 0, 255, 0.3);
      animation: neonPulse 2s ease-in-out infinite;
    }
    @keyframes neonPulse {
      0%, 100% { 
        text-shadow: 
          0 0 10px rgba(0, 255, 255, 0.8),
          0 0 20px rgba(0, 255, 255, 0.6),
          0 0 30px rgba(0, 255, 255, 0.4);
      }
      50% { 
        text-shadow: 
          0 0 20px rgba(0, 255, 255, 1),
          0 0 30px rgba(255, 0, 255, 0.8),
          0 0 40px rgba(0, 255, 255, 0.6),
          0 0 50px rgba(255, 0, 255, 0.4);
      }
    }
    .subtitle {
      font-family: 'Orbitron', monospace;
      text-align: center;
      color: var(--magenta);
      margin-bottom: 20px;
      font-size: 1.3em;
      font-weight: 700;
      letter-spacing: 4px;
      text-shadow: 0 0 10px rgba(255, 0, 255, 0.8);
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px 20px;
      background: rgba(15, 15, 25, 0.95);
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
    }
    .btn {
      padding: 12px 24px;
      border: 2px solid;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 700;
      font-family: 'Orbitron', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-shadow: 0 0 5px currentColor;
      background: none;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.5s, height 0.5s;
    }
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 25px currentColor;
    }
    .btn-back {
      color: var(--cyan);
      border-color: var(--cyan);
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }
    .btn-start {
      color: var(--green);
      border-color: var(--green);
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
      font-size: 1.2em;
      padding: 15px 40px;
    }
    .btn-stop {
      color: var(--red);
      border-color: var(--red);
      box-shadow: 0 0 15px rgba(255, 0, 85, 0.3);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .main-grid {
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: rgba(15, 15, 25, 0.95);
      border-radius: 15px;
      padding: 20px;
      border: 2px solid rgba(0, 255, 255, 0.3);
      box-shadow: 
        0 0 20px rgba(0, 255, 255, 0.2),
        inset 0 0 15px rgba(0, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
    }
    .card::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.1), transparent);
      transition: left 0.5s ease;
    }
    .card:hover::after {
      left: 100%;
    }
    .card-title {
      font-family: 'Orbitron', monospace;
      font-size: 1.3em;
      margin-bottom: 15px;
      color: var(--cyan);
      border-bottom: 2px solid var(--cyan);
      padding-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
    .player-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .player-card {
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid;
      border-radius: 10px;
      padding: 15px;
      transition: all 0.3s ease;
    }
    .player-card.active {
      box-shadow: 0 0 20px currentColor;
      transform: scale(1.05);
    }
    .player-card.winner {
      animation: winnerPulse 1s ease-in-out infinite;
    }
    @keyframes winnerPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }
    .player-name {
      font-family: 'Orbitron', monospace;
      font-size: 1.2em;
      font-weight: 700;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    .player-chips {
      font-size: 1.8em;
      font-weight: 900;
      font-family: 'Orbitron', monospace;
      text-shadow: 0 0 10px currentColor;
    }
    .player-bet {
      margin-top: 10px;
      font-size: 0.9em;
      opacity: 0.8;
    }
    .add-player-btn {
      width: 100%;
      padding: 15px;
      margin-top: 10px;
      color: var(--green);
      border-color: var(--green);
    }
    .roulette-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .roulette-wheel {
      width: 450px;
      height: 450px;
      border-radius: 50%;
      border: 8px solid var(--cyan);
      box-shadow: 
        0 0 40px rgba(0, 255, 255, 0.6),
        inset 0 0 40px rgba(0, 255, 255, 0.3);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
    }
    #rouletteCanvas {
      border-radius: 50%;
    }
    .roulette-pointer {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 30px solid var(--yellow);
      filter: drop-shadow(0 0 10px var(--yellow));
      z-index: 10;
      animation: pointerBlink 1s ease-in-out infinite;
    }
    @keyframes pointerBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .roulette-center {
      position: absolute;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--dark);
      border: 4px solid var(--cyan);
      box-shadow: 0 0 20px var(--cyan);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Orbitron', monospace;
      font-weight: 900;
      font-size: 1.5em;
      color: var(--cyan);
      z-index: 5;
    }
    .result-display {
      font-family: 'Orbitron', monospace;
      font-size: 2em;
      font-weight: 900;
      text-align: center;
      padding: 20px;
      border-radius: 10px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid rgba(0, 255, 255, 0.5);
    }
    .betting-panel {
      width: 100%;
    }
    .color-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    .color-btn {
      padding: 15px;
      border: 3px solid;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      font-size: 1em;
      text-transform: uppercase;
      transition: all 0.3s ease;
      background: rgba(0, 0, 0, 0.5);
    }
    .color-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px currentColor;
    }
    .color-btn.selected {
      box-shadow: 0 0 30px currentColor;
      transform: scale(1.1);
      animation: selectedPulse 1s ease-in-out infinite;
    }
    @keyframes selectedPulse {
      0%, 100% { border-width: 3px; }
      50% { border-width: 5px; }
    }
    .bet-input-group {
      margin: 15px 0;
    }
    .bet-input-group label {
      display: block;
      margin-bottom: 8px;
      font-family: 'Orbitron', monospace;
      color: var(--cyan);
      font-weight: 700;
      text-transform: uppercase;
    }
    .bet-input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--cyan);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-family: 'Orbitron', monospace;
      font-size: 1.2em;
      font-weight: 700;
      text-align: center;
    }
    .bet-input-group input:focus {
      outline: none;
      box-shadow: 0 0 20px var(--cyan);
    }
    .quick-bet-btns {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .quick-bet-btn {
      padding: 8px;
      border: 2px solid var(--yellow);
      color: var(--yellow);
      background: rgba(255, 170, 0, 0.1);
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    .quick-bet-btn:hover {
      background: rgba(255, 170, 0, 0.3);
      box-shadow: 0 0 15px var(--yellow);
    }
    .place-bet-btn {
      width: 100%;
      padding: 18px;
      margin-top: 15px;
      color: var(--magenta);
      border-color: var(--magenta);
      font-size: 1.1em;
    }
    .game-stats {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 10px;
      border: 2px solid rgba(0, 255, 255, 0.3);
    }
    .stat-item {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-family: 'Orbitron', monospace;
    }
    .stat-label {
      color: var(--cyan);
      font-weight: 700;
    }
    .stat-value {
      font-weight: 900;
      font-size: 1.1em;
    }
    .history-list {
      max-height: 200px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 8px;
      border: 2px solid rgba(0, 255, 255, 0.2);
    }
    .history-item {
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid;
      font-family: 'Orbitron', monospace;
      font-size: 0.9em;
    }
    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0a0a0f;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .loading-roulette {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      border: 8px solid transparent;
      border-top-color: var(--cyan);
      border-right-color: var(--magenta);
      animation: spinLoader 1.5s linear infinite;
      position: relative;
      box-shadow: 
        0 0 40px rgba(0, 255, 255, 0.6),
        0 0 60px rgba(255, 0, 255, 0.4);
    }
    .loading-roulette::before {
      content: '🎰';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4em;
      animation: pulse 1s ease-in-out infinite;
    }
    @keyframes spinLoader {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; }
    }
    .loading-text {
      font-family: 'Orbitron', monospace;
      font-size: 2em;
      font-weight: 900;
      color: var(--cyan);
      margin-top: 40px;
      text-transform: uppercase;
      letter-spacing: 5px;
      text-shadow: 
        0 0 10px rgba(0, 255, 255, 0.8),
        0 0 20px rgba(0, 255, 255, 0.6);
      animation: textGlow 2s ease-in-out infinite;
    }
    @keyframes textGlow {
      0%, 100% { 
        text-shadow: 
          0 0 10px rgba(0, 255, 255, 0.8),
          0 0 20px rgba(0, 255, 255, 0.6);
      }
      50% { 
        text-shadow: 
          0 0 20px rgba(0, 255, 255, 1),
          0 0 40px rgba(255, 0, 255, 0.8),
          0 0 60px rgba(0, 255, 255, 0.6);
      }
    }
    .loading-bar {
      width: 300px;
      height: 8px;
      background: rgba(0, 255, 255, 0.2);
      border-radius: 10px;
      margin-top: 30px;
      overflow: hidden;
      border: 2px solid var(--cyan);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
    }
    .loading-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--cyan), var(--magenta), var(--cyan));
      background-size: 200% 100%;
      animation: loadingBar 2s ease-in-out;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
    }
    @keyframes loadingBar {
      0% { width: 0%; background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { width: 100%; background-position: 200% 50%; }
    }
    .content-wrapper {
      opacity: 0;
      transform: scale(0.95);
      animation: fadeInContent 0.8s ease forwards;
      animation-delay: 2s;
    }
    @keyframes fadeInContent {
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      .roulette-wheel {
        width: 300px;
        height: 300px;
      }
      h1 {
        font-size: 2em;
      }
      .loading-text {
        font-size: 1.5em;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-roulette"></div>
    <div class="loading-text">CARREGANDO CASINO</div>
    <div class="loading-bar">
      <div class="loading-bar-fill"></div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper">
    <div class="container">
      <h1>⚡ FRANZININHO CASINO ⚡</h1>
      <p class="subtitle">[ ROLETA RGB - SISTEMA DE APOSTAS ]</p>

    <div class="top-bar">
      <button class="btn btn-back" onclick="window.location.href='mqtt_viewer.html'">
        ← VOLTAR AO DASHBOARD
      </button>
      <div style="font-family: 'Orbitron', monospace; font-size: 1.2em; color: var(--cyan);">
        <span id="statusIndicator">●</span> <span id="statusText">CONECTANDO...</span>
      </div>
      <button class="btn btn-start" id="startGameBtn" onclick="startGame()">
        ▶ INICIAR JOGO
      </button>
    </div>

    <div class="main-grid">
      <!-- Players Panel -->
      <div class="card">
        <div class="card-title">👥 JOGADORES</div>
        <div class="player-list" id="playerList">
          <!-- Players will be added here -->
        </div>
        <button class="btn add-player-btn" id="addPlayerBtn" onclick="addPlayer()">
          ➕ ADICIONAR JOGADOR
        </button>
      </div>

      <!-- Roulette Panel -->
      <div class="card">
        <div class="roulette-container">
          <div class="roulette-wheel">
            <div class="roulette-pointer"></div>
            <canvas id="rouletteCanvas" width="400" height="400"></canvas>
            <div class="roulette-center">RGB</div>
          </div>
          <div class="result-display" id="resultDisplay">
            AGUARDANDO INÍCIO...
          </div>
          <button class="btn btn-start" id="spinBtn" onclick="spinRoulette()" disabled style="width: 300px;">
            🎰 GIRAR ROLETA
          </button>
        </div>
      </div>

      <!-- Betting Panel -->
      <div class="card">
        <div class="card-title">🎲 PAINEL DE APOSTAS</div>
        <div class="betting-panel" id="bettingPanel">
          <div style="text-align: center; margin: 20px 0; color: var(--yellow);">
            Adicione jogadores para começar
          </div>
        </div>

        <div style="margin-top: 20px;">
          <div class="card-title" style="font-size: 1em; margin-bottom: 10px;">📊 ESTATÍSTICAS</div>
          <div class="game-stats">
            <div class="stat-item">
              <span class="stat-label">RODADA:</span>
              <span class="stat-value" id="roundNumber">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">TOTAL APOSTADO:</span>
              <span class="stat-value" id="totalBet">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">POT ACUMULADO:</span>
              <span class="stat-value" id="potValue">0</span>
            </div>
          </div>
        </div>

        <div style="margin-top: 15px;">
          <div class="card-title" style="font-size: 1em; margin-bottom: 10px;">📜 HISTÓRICO</div>
          <div class="history-list" id="historyList">
            <div style="text-align: center; opacity: 0.5;">Nenhuma rodada ainda</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Audio Elements -->
  <audio id="spinSound" style="display: none;"></audio>
  <audio id="winSound" style="display: none;"></audio>
  <audio id="entranceSound" style="display: none;"></audio>

  <script>
    // MQTT Setup
    const MQTT_HOST = 'broker.hivemq.com';
    const MQTT_PORT = 8000;
    const clientId = 'franzininho-casino-' + Math.random().toString(16).slice(2, 10);
    const TOPIC_ROULETTE_RESULT = 'IFCE_caua/roulette_result';
    const TOPIC_ROULETTE_SPIN = 'IFCE_caua/roulette_spin';
    
    let mqttClient;
    let players = [];
    let currentPlayerIndex = 0;
    let gameStarted = false;
    let roundNumber = 0;
    let isSpinning = false;
    let history = [];
    let canvas, ctx;
    let currentRotation = 0;
    let targetRotation = 0;
    let spinStartTime = 0;
    let spinDuration = 3000; // 3 segundos

    // Roulette colors (10 segments) - Disposição: V, A, V, A, B, V, A, V, A, B
    const expandedColors = [
      { name: 'RED', color: '#ff0055', multiplier: 1 },      // 0
      { name: 'BLUE', color: '#0080ff', multiplier: 1 },     // 1
      { name: 'RED', color: '#ff0055', multiplier: 1 },      // 2
      { name: 'BLUE', color: '#0080ff', multiplier: 1 },     // 3
      { name: 'WHITE', color: '#ffffff', multiplier: 2 },    // 4 - BRANCO (centro)
      { name: 'RED', color: '#ff0055', multiplier: 1 },      // 5 
      { name: 'BLUE', color: '#0080ff', multiplier: 1 },     // 6
      { name: 'RED', color: '#ff0055', multiplier: 1 },      // 7
      { name: 'BLUE', color: '#0080ff', multiplier: 1 },     // 8
      { name: 'WHITE', color: '#ffffff', multiplier: 2 }     // 9 - BRANCO (oposto)
    ];

    // Initialize MQTT
    function initMQTT() {
      mqttClient = mqtt.connect(`ws://${MQTT_HOST}:${MQTT_PORT}/mqtt`);
      
      mqttClient.on('connect', () => {
        document.getElementById('statusText').textContent = 'ONLINE';
        document.getElementById('statusIndicator').style.color = 'var(--green)';
        mqttClient.subscribe(TOPIC_ROULETTE_RESULT);
        console.log('MQTT Connected');
      });

      mqttClient.on('message', (topic, message) => {
        if (topic === TOPIC_ROULETTE_RESULT) {
          const msg = message.toString();
          console.log('Roulette result:', msg);
        }
      });

      mqttClient.on('error', (err) => {
        console.error('MQTT Error:', err);
        document.getElementById('statusText').textContent = 'ERRO';
        document.getElementById('statusIndicator').style.color = 'var(--red)';
      });
    }

    // Create roulette wheel with Canvas
    function createRouletteWheel() {
      canvas = document.getElementById('rouletteCanvas');
      ctx = canvas.getContext('2d');
      drawRoulette();
    }

    function drawRoulette() {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = canvas.width / 2 - 10;
      const anglePerSegment = (Math.PI * 2) / expandedColors.length;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate(currentRotation);

      // Draw segments
      expandedColors.forEach((colorObj, index) => {
        const startAngle = index * anglePerSegment;
        const endAngle = startAngle + anglePerSegment;

        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.arc(0, 0, radius, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = colorObj.color;
        ctx.fill();
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Add text
        ctx.save();
        ctx.rotate(startAngle + anglePerSegment / 2);
        ctx.textAlign = 'center';
        ctx.fillStyle = colorObj.name === 'WHITE' ? '#000' : '#fff';
        ctx.font = 'bold 14px Orbitron';
        ctx.fillText(colorObj.name, radius * 0.7, 5);
        ctx.restore();
      });

      ctx.restore();
    }

    function animateRoulette() {
      if (!isSpinning) return;

      const elapsed = Date.now() - spinStartTime;
      const progress = Math.min(elapsed / spinDuration, 1);

      // Easing function (ease-out cubic)
      const easeOut = 1 - Math.pow(1 - progress, 3);
      
      currentRotation = easeOut * targetRotation;
      drawRoulette();

      if (progress < 1) {
        requestAnimationFrame(animateRoulette);
      } else {
        isSpinning = false;
        // Normalizar rotação
        currentRotation = currentRotation % (Math.PI * 2);
      }
    }

    // Add player
    function addPlayer() {
      if (players.length >= 3) {
        alert('MÁXIMO DE 3 JOGADORES!');
        return;
      }
      if (gameStarted) {
        alert('NÃO É POSSÍVEL ADICIONAR JOGADORES DURANTE O JOGO!');
        return;
      }

      // Pedir nome do jogador
      const playerName = prompt('Digite o nome do jogador:', `PLAYER ${players.length + 1}`);
      if (!playerName || playerName.trim() === '') {
        return; // Cancelou ou nome vazio
      }

      const playerNum = players.length + 1;
      const playerColors = ['#ff0055', '#00ff41', '#0080ff'];
      
      const player = {
        id: playerNum,
        name: playerName.trim().toUpperCase(),
        chips: 200,
        color: playerColors[playerNum - 1],
        bet: 0,
        betColor: null
      };

      players.push(player);
      updatePlayersList();
      updateBettingPanel();

      if (players.length === 3) {
        document.getElementById('addPlayerBtn').disabled = true;
        document.getElementById('addPlayerBtn').style.opacity = '0.3';
      }
    }

    // Update players list
    function updatePlayersList() {
      const list = document.getElementById('playerList');
      list.innerHTML = '';

      players.forEach((player, index) => {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.style.borderColor = player.color;
        if (index === currentPlayerIndex && gameStarted) {
          card.classList.add('active');
        }
        
        card.innerHTML = `
          <div class="player-name" style="color: ${player.color}">${player.name}</div>
          <div class="player-chips" style="color: ${player.color}">💰 ${player.chips}</div>
          ${player.bet > 0 ? `<div class="player-bet">Aposta: ${player.bet} em ${player.betColor}</div>` : ''}
        `;
        list.appendChild(card);
      });
    }

    // Update betting panel
    function updateBettingPanel() {
      const panel = document.getElementById('bettingPanel');
      
      if (players.length === 0 || !gameStarted) {
        panel.innerHTML = '<div style="text-align: center; margin: 20px 0; color: var(--yellow);">Adicione jogadores e inicie o jogo</div>';
        return;
      }

      const currentPlayer = players[currentPlayerIndex];
      
      panel.innerHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
          <div style="font-size: 1.3em; color: ${currentPlayer.color}; font-family: 'Orbitron', monospace; font-weight: 900;">
            ${currentPlayer.name}
          </div>
          <div style="font-size: 1.5em; color: ${currentPlayer.color}; font-family: 'Orbitron', monospace; font-weight: 900;">
            💰 ${currentPlayer.chips} FICHAS
          </div>
        </div>

        <div class="color-options">
          <button class="color-btn" onclick="selectColor('RED')" id="betRed" style="color: #ff0055; border-color: #ff0055;">
            🔴 VERMELHO (40%)
          </button>
          <button class="color-btn" onclick="selectColor('BLUE')" id="betBlue" style="color: #0080ff; border-color: #0080ff;">
            🔵 AZUL (40%)
          </button>
          <button class="color-btn" onclick="selectColor('WHITE')" id="betWhite" style="color: #ffffff; border-color: #ffffff;">
            ⚪ BRANCO (20% - x2)
          </button>
        </div>

        <div class="bet-input-group">
          <label>Valor da Aposta:</label>
          <input type="number" id="betAmount" min="10" max="${currentPlayer.chips}" step="10" value="10" />
        </div>

        <div class="quick-bet-btns">
          <button class="quick-bet-btn" onclick="setQuickBet(10)">10</button>
          <button class="quick-bet-btn" onclick="setQuickBet(25)">25</button>
          <button class="quick-bet-btn" onclick="setQuickBet(50)">50</button>
          <button class="quick-bet-btn" onclick="setQuickBet(100)">100</button>
        </div>

        <button class="btn place-bet-btn" onclick="placeBet()">
          💎 CONFIRMAR APOSTA
        </button>
      `;
    }

    let selectedColor = null;

    function selectColor(color) {
      selectedColor = color;
      ['betRed', 'betBlue', 'betWhite'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.classList.remove('selected');
      });
      const btnId = 'bet' + color.charAt(0).toUpperCase() + color.slice(1).toLowerCase();
      const btn = document.getElementById(btnId);
      if (btn) btn.classList.add('selected');
    }

    function setQuickBet(amount) {
      const input = document.getElementById('betAmount');
      if (input) input.value = Math.min(amount, players[currentPlayerIndex].chips);
    }

    function placeBet() {
      if (!selectedColor) {
        alert('SELECIONE UMA COR PRIMEIRO!');
        return;
      }

      const amount = parseInt(document.getElementById('betAmount').value);
      const currentPlayer = players[currentPlayerIndex];

      if (amount < 10) {
        alert('APOSTA MÍNIMA: 10 FICHAS!');
        return;
      }

      if (amount > currentPlayer.chips) {
        alert('FICHAS INSUFICIENTES!');
        return;
      }

      currentPlayer.bet = amount;
      currentPlayer.betColor = selectedColor;
      currentPlayer.chips -= amount;

      updatePlayersList();
      
      // Move to next player or enable spin
      currentPlayerIndex++;
      if (currentPlayerIndex >= players.length) {
        currentPlayerIndex = 0;
        document.getElementById('spinBtn').disabled = false;
        document.getElementById('bettingPanel').innerHTML = '<div style="text-align: center; margin: 20px 0; color: var(--green); font-size: 1.2em;">TODAS AS APOSTAS CONFIRMADAS!<br/>GIRE A ROLETA!</div>';
      } else {
        updateBettingPanel();
      }

      updateStats();
    }

    function startGame() {
      if (players.length === 0) {
        alert('ADICIONE PELO MENOS 1 JOGADOR!');
        return;
      }

      gameStarted = true;
      roundNumber = 1;
      currentPlayerIndex = 0;
      document.getElementById('startGameBtn').disabled = true;
      document.getElementById('addPlayerBtn').disabled = true;
      document.getElementById('resultDisplay').textContent = 'RODADA ' + roundNumber + ' - FAÇAM SUAS APOSTAS!';
      
      updatePlayersList();
      updateBettingPanel();
      updateStats();
    }

    function spinRoulette() {
      if (isSpinning) return;
      isSpinning = true;
      document.getElementById('spinBtn').disabled = true;

      // Play enhanced spin sound with Web Audio API
      playSpinSound();

      // Random result - escolhe o índice vencedor
      const resultIndex = Math.floor(Math.random() * expandedColors.length);
      const result = expandedColors[resultIndex];
      
      // Calculate rotation para Canvas
      // O ponteiro está no topo (0°), então ajustamos para que o segmento vencedor fique no topo
      const anglePerSegment = (Math.PI * 2) / expandedColors.length;
      const fullRotations = Math.PI * 2 * 5; // 5 voltas completas
      
      // Calcular ângulo para o segmento ficar no topo (ponteiro aponta para baixo na roleta)
      // Precisamos compensar para que o CENTRO do segmento fique alinhado com o ponteiro
      const segmentAngle = resultIndex * anglePerSegment;
      // Ajuste: subtrair meio segmento para centralizar + compensar orientação do ponteiro
      const adjustedAngle = segmentAngle + (anglePerSegment / 2);
      
      // Rotação total: voltas completas + ângulo do segmento (invertido porque giramos no sentido horário)
      targetRotation = fullRotations + (Math.PI * 2 - adjustedAngle);
      
      spinStartTime = Date.now();
      animateRoulette();

      document.getElementById('resultDisplay').textContent = '🎰 GIRANDO...';

      // Send MQTT message to ESP32
      if (mqttClient && mqttClient.connected) {
        mqttClient.publish(TOPIC_ROULETTE_SPIN, 'spinning');
      }

      setTimeout(() => {
        processResult(result);

        // Send result to ESP32 (LED color)
        if (mqttClient && mqttClient.connected) {
          let rgbColor = '';
          switch(result.name) {
            case 'RED': rgbColor = '255,0,0'; break;
            case 'GREEN': rgbColor = '0,255,0'; break;
            case 'BLUE': rgbColor = '0,0,255'; break;
            case 'WHITE': rgbColor = '255,255,255'; break;
          }
          mqttClient.publish('IFCE_caua/led_control', rgbColor);
          mqttClient.publish(TOPIC_ROULETTE_RESULT, result.name);
        }
      }, spinDuration);
    }

    function processResult(result) {
      let winners = [];
      let totalPot = 0;

      players.forEach(player => {
        totalPot += player.bet;
        if (player.betColor === result.name) {
          const winAmount = player.bet * result.multiplier * 2; // Win = bet back + prize
          player.chips += winAmount;
          winners.push(player);
        }
        player.bet = 0;
        player.betColor = null;
      });

      // Play win sound if there are winners
      if (winners.length > 0) {
        playWinSound();
      }

      // Update result display
      let resultText = `🎉 RESULTADO: ${result.name} 🎉`;
      if (winners.length > 0) {
        resultText += `\nVENCEDORES: ${winners.map(p => p.name).join(', ')}`;
      } else {
        resultText += `\nNENHUM VENCEDOR`;
      }
      document.getElementById('resultDisplay').textContent = resultText;

      // Add to history
      history.unshift({
        round: roundNumber,
        color: result.name,
        winners: winners.length
      });
      updateHistory();

      // Check if game continues
      const activePlayers = players.filter(p => p.chips >= 10);
      
      if (activePlayers.length === 0) {
        setTimeout(() => {
          alert('JOGO FINALIZADO! TODOS OS JOGADORES PERDERAM SUAS FICHAS!');
          resetGame();
        }, 2000);
      } else if (activePlayers.length < players.length) {
        // Remove players with no chips
        players = activePlayers;
        setTimeout(() => {
          alert('ALGUNS JOGADORES FORAM ELIMINADOS!');
          nextRound();
        }, 2000);
      } else {
        setTimeout(() => {
          nextRound();
        }, 3000);
      }

      updatePlayersList();
      updateStats();
    }

    function nextRound() {
      roundNumber++;
      currentPlayerIndex = 0;
      document.getElementById('resultDisplay').textContent = 'RODADA ' + roundNumber + ' - FAÇAM SUAS APOSTAS!';
      updateBettingPanel();
      updateStats();
    }

    function resetGame() {
      players = [];
      currentPlayerIndex = 0;
      gameStarted = false;
      roundNumber = 0;
      history = [];
      
      document.getElementById('startGameBtn').disabled = false;
      document.getElementById('addPlayerBtn').disabled = false;
      document.getElementById('addPlayerBtn').style.opacity = '1';
      document.getElementById('resultDisplay').textContent = 'AGUARDANDO INÍCIO...';
      
      updatePlayersList();
      updateBettingPanel();
      updateStats();
      updateHistory();
    }

    function updateStats() {
      document.getElementById('roundNumber').textContent = roundNumber;
      const totalBet = players.reduce((sum, p) => sum + p.bet, 0);
      document.getElementById('totalBet').textContent = totalBet;
      document.getElementById('potValue').textContent = totalBet;
    }

    function updateHistory() {
      const list = document.getElementById('historyList');
      if (history.length === 0) {
        list.innerHTML = '<div style="text-align: center; opacity: 0.5;">Nenhuma rodada ainda</div>';
        return;
      }

      list.innerHTML = history.map(h => {
        let color = '';
        switch(h.color) {
          case 'RED': color = '#ff0055'; break;
          case 'GREEN': color = '#00ff41'; break;
          case 'BLUE': color = '#0080ff'; break;
          case 'WHITE': color = '#ffffff'; break;
        }
        return `<div class="history-item" style="border-color: ${color}; color: ${color};">
          R${h.round}: ${h.color} - ${h.winners} vencedor(es)
        </div>`;
      }).join('');
    }

    // Play entrance sound effect with Web Audio API
    function playEntranceSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.type = 'sine';
      
      // Create ascending melody
      const notes = [262, 330, 392, 523]; // C, E, G, C (chord progression)
      let time = audioContext.currentTime;
      
      notes.forEach((freq, index) => {
        oscillator.frequency.setValueAtTime(freq, time);
        gainNode.gain.setValueAtTime(0.3, time);
        gainNode.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
        time += 0.3;
      });

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 1.5);
    }

    // Play spinning sound effect
    function playSpinSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      
      // Create multiple oscillators for richer sound
      for (let i = 0; i < 20; i++) {
        setTimeout(() => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          
          osc.connect(gain);
          gain.connect(audioContext.destination);
          
          osc.type = 'square';
          osc.frequency.value = 200 + (i * 30); // Increasing frequency
          gain.gain.value = 0.1;
          
          osc.start();
          osc.stop(audioContext.currentTime + 0.1);
        }, i * 150);
      }
    }

    // Play win sound effect
    function playWinSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const notes = [523, 659, 784, 1047]; // C, E, G, high C
      
      notes.forEach((freq, index) => {
        setTimeout(() => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          
          osc.connect(gain);
          gain.connect(audioContext.destination);
          
          osc.type = 'sine';
          osc.frequency.value = freq;
          gain.gain.value = 0.3;
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
          
          osc.start();
          osc.stop(audioContext.currentTime + 0.5);
        }, index * 150);
      });
    }

    // Cleanup ao sair da página
    window.addEventListener('beforeunload', () => {
      if (mqttClient && mqttClient.connected) {
        mqttClient.publish('IFCE_caua/led_control', '0,0,0');
        mqttClient.publish('IFCE_caua/buzzer_control', '0');
        mqttClient.publish('IFCE_caua/display_msg', 'Casino Menu');
      }
    });

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      createRouletteWheel();
      initMQTT();
      updatePlayersList();
      updateBettingPanel();
      updateStats();

      // Play entrance sound
      playEntranceSound();

      // Hide loading screen after 2 seconds
      setTimeout(() => {
        const loadingScreen = document.getElementById('loadingScreen');
        loadingScreen.classList.add('hidden');
        
        // Remove from DOM after transition
        setTimeout(() => {
          loadingScreen.remove();
        }, 500);
      }, 2000);
    });
  </script>
  </div> <!-- end content-wrapper -->
</body>
</html>
