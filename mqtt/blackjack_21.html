<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>üÉè BLACKJACK 21 - Franzininho Casino</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { 
      font-family: 'Rajdhani', sans-serif;
      --cyan: #00ffff;
      --magenta: #ff00ff;
      --green: #00ff41;
      --red: #ff0055;
      --yellow: #ffaa00;
      --dark: #0a0a0f;
    }
    body { 
      background: #0a0a0f;
      background-image: 
        repeating-linear-gradient(0deg, rgba(0, 255, 65, 0.03) 0px, transparent 1px, transparent 2px, rgba(0, 255, 65, 0.03) 3px),
        repeating-linear-gradient(90deg, rgba(0, 255, 65, 0.03) 0px, transparent 1px, transparent 2px, rgba(0, 255, 65, 0.03) 3px),
        radial-gradient(circle at 50% 50%, rgba(0, 255, 65, 0.15) 0%, transparent 50%);
      background-size: 50px 50px, 50px 50px, 100% 100%;
      min-height: 100vh;
      padding: 20px;
      color: #e0e0e0;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(transparent 50%, rgba(0, 255, 65, 0.02) 50%);
      background-size: 4px 4px;
      pointer-events: none;
      z-index: 1;
      animation: scanlines 10s linear infinite;
    }
    @keyframes scanlines {
      0% { transform: translateY(0); }
      100% { transform: translateY(4px); }
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0a0a0f;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .loading-cards {
      width: 200px;
      height: 200px;
      position: relative;
    }
    .loading-card {
      position: absolute;
      width: 80px;
      height: 120px;
      background: linear-gradient(135deg, var(--green), var(--cyan));
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0, 255, 65, 0.6);
      animation: cardDeal 2s ease-in-out infinite;
    }
    .loading-card:nth-child(1) {
      top: 40px;
      left: 20px;
      animation-delay: 0s;
    }
    .loading-card:nth-child(2) {
      top: 40px;
      left: 100px;
      animation-delay: 0.3s;
    }
    @keyframes cardDeal {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 1; }
      50% { transform: translateY(-30px) rotate(10deg); opacity: 0.7; }
    }
    .loading-text {
      font-family: 'Orbitron', monospace;
      font-size: 2em;
      font-weight: 900;
      color: var(--green);
      margin-top: 40px;
      text-transform: uppercase;
      letter-spacing: 5px;
      text-shadow: 0 0 20px rgba(0, 255, 65, 0.8);
      animation: textGlow 2s ease-in-out infinite;
    }
    @keyframes textGlow {
      0%, 100% { 
        text-shadow: 0 0 10px rgba(0, 255, 65, 0.8);
      }
      50% { 
        text-shadow: 0 0 30px rgba(0, 255, 65, 1);
      }
    }

    .content-wrapper {
      opacity: 0;
      transform: scale(0.95);
      animation: fadeInContent 0.8s ease forwards;
      animation-delay: 2s;
    }
    @keyframes fadeInContent {
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      position: relative;
      z-index: 2;
    }
    h1 {
      font-family: 'Orbitron', monospace;
      color: var(--green);
      text-align: center;
      margin-bottom: 10px;
      font-size: 3.5em;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 8px;
      text-shadow: 
        0 0 10px rgba(0, 255, 65, 0.8),
        0 0 20px rgba(0, 255, 65, 0.6),
        0 0 30px rgba(0, 255, 65, 0.4);
      animation: glowPulse 3s ease-in-out infinite;
    }
    @keyframes glowPulse {
      0%, 100% { 
        text-shadow: 
          0 0 10px rgba(0, 255, 65, 0.8),
          0 0 20px rgba(0, 255, 65, 0.6);
      }
      50% { 
        text-shadow: 
          0 0 20px rgba(0, 255, 65, 1),
          0 0 40px rgba(0, 255, 65, 0.8),
          0 0 60px rgba(0, 255, 65, 0.6);
      }
    }
    .subtitle {
      font-family: 'Orbitron', monospace;
      text-align: center;
      color: var(--cyan);
      margin-bottom: 20px;
      font-size: 1.3em;
      font-weight: 700;
      letter-spacing: 4px;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px 20px;
      background: rgba(15, 15, 25, 0.95);
      border: 2px solid rgba(0, 255, 65, 0.3);
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(0, 255, 65, 0.2);
    }
    .btn {
      padding: 12px 24px;
      border: 2px solid;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 700;
      font-family: 'Orbitron', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-shadow: 0 0 5px currentColor;
      background: none;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.5s, height 0.5s;
    }
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 20px currentColor;
    }
    .btn-back {
      color: var(--cyan);
      border-color: var(--cyan);
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }
    .btn-start {
      color: var(--green);
      border-color: var(--green);
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
      font-size: 1.2em;
      padding: 15px 40px;
    }
    .btn-hit {
      color: var(--green);
      border-color: var(--green);
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
    }
    .btn-stand {
      color: var(--yellow);
      border-color: var(--yellow);
      box-shadow: 0 0 15px rgba(255, 170, 0, 0.3);
    }
    .btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(15, 15, 25, 0.95);
      border-radius: 15px;
      padding: 20px;
      border: 2px solid rgba(0, 255, 65, 0.3);
      box-shadow: 
        0 0 20px rgba(0, 255, 65, 0.2),
        inset 0 0 15px rgba(0, 255, 65, 0.05);
      position: relative;
      overflow: hidden;
    }

    .card-title {
      font-family: 'Orbitron', monospace;
      font-size: 1.3em;
      margin-bottom: 15px;
      color: var(--green);
      border-bottom: 2px solid var(--green);
      padding-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
    }

    .player-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .player-card {
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid;
      border-radius: 10px;
      padding: 15px;
      transition: all 0.3s ease;
    }

    .player-card.active {
      box-shadow: 0 0 25px currentColor;
      transform: scale(1.05);
      animation: activePulse 1.5s ease-in-out infinite;
    }

    @keyframes activePulse {
      0%, 100% { box-shadow: 0 0 20px currentColor; }
      50% { box-shadow: 0 0 35px currentColor; }
    }

    .player-name {
      font-family: 'Orbitron', monospace;
      font-size: 1.1em;
      font-weight: 700;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .player-chips {
      font-size: 1.5em;
      font-weight: 900;
      font-family: 'Orbitron', monospace;
      text-shadow: 0 0 10px currentColor;
    }

    .player-bet {
      margin-top: 8px;
      font-size: 0.9em;
      opacity: 0.9;
    }

    .add-player-btn {
      width: 100%;
      padding: 15px;
      margin-top: 10px;
      color: var(--green);
      border-color: var(--green);
    }

    .dealer-section, .player-section {
      margin-bottom: 30px;
    }

    .section-title {
      font-family: 'Orbitron', monospace;
      font-size: 1.8em;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .dealer-section .section-title {
      color: var(--red);
      text-shadow: 0 0 15px rgba(255, 0, 85, 0.8);
    }

    .player-section .section-title {
      color: var(--green);
      text-shadow: 0 0 15px rgba(0, 255, 65, 0.8);
    }

    .cards-display {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 15px;
      min-height: 150px;
    }

    .playing-card {
      width: 100px;
      height: 140px;
      background: white;
      border-radius: 10px;
      border: 3px solid #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      font-weight: 900;
      font-family: 'Orbitron', monospace;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
      animation: cardFlip 0.5s ease;
      position: relative;
    }

    @keyframes cardFlip {
      0% { transform: rotateY(90deg) scale(0.8); opacity: 0; }
      100% { transform: rotateY(0deg) scale(1); opacity: 1; }
    }

    .playing-card.red {
      color: #ff0000;
    }

    .playing-card.black {
      color: #000;
    }

    .playing-card.hidden {
      background: linear-gradient(135deg, #1a1a2e, #0a0a0f);
      color: transparent;
      border-color: var(--green);
    }

    .playing-card.hidden::after {
      content: '?';
      color: var(--green);
      font-size: 3em;
      text-shadow: 0 0 20px rgba(0, 255, 65, 0.8);
    }

    .card-value {
      font-size: 0.4em;
      position: absolute;
      top: 5px;
      left: 8px;
    }

    .card-suit {
      font-size: 0.5em;
    }

    .score-display {
      font-family: 'Orbitron', monospace;
      font-size: 2em;
      font-weight: 900;
      margin-bottom: 15px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      border: 2px solid;
      text-align: center;
    }

    .dealer-section .score-display {
      border-color: var(--red);
      color: var(--red);
      text-shadow: 0 0 15px rgba(255, 0, 85, 0.8);
    }

    .player-section .score-display {
      border-color: var(--green);
      color: var(--green);
      text-shadow: 0 0 15px rgba(0, 255, 65, 0.8);
    }

    .actions {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .betting-panel {
      background: rgba(0, 0, 0, 0.5);
      padding: 20px;
      border-radius: 10px;
      border: 2px solid rgba(0, 255, 65, 0.3);
      margin-bottom: 20px;
    }

    .bet-input-group {
      margin: 15px 0;
    }

    .bet-input-group label {
      display: block;
      margin-bottom: 8px;
      font-family: 'Orbitron', monospace;
      color: var(--green);
      font-weight: 700;
      text-transform: uppercase;
    }

    .bet-input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--green);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-family: 'Orbitron', monospace;
      font-size: 1.2em;
      font-weight: 700;
      text-align: center;
    }

    .bet-input-group input:focus {
      outline: none;
      box-shadow: 0 0 20px var(--green);
    }

    .quick-bet-btns {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .quick-bet-btn {
      padding: 10px;
      border: 2px solid var(--yellow);
      color: var(--yellow);
      background: rgba(255, 170, 0, 0.1);
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .quick-bet-btn:hover {
      background: rgba(255, 170, 0, 0.3);
      box-shadow: 0 0 15px var(--yellow);
    }

    .result-message {
      font-family: 'Orbitron', monospace;
      font-size: 2.5em;
      font-weight: 900;
      text-align: center;
      padding: 30px;
      margin: 20px 0;
      border-radius: 15px;
      text-transform: uppercase;
      letter-spacing: 3px;
      animation: resultFade 0.5s ease;
    }

    @keyframes resultFade {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    .result-win {
      background: rgba(0, 255, 65, 0.2);
      border: 3px solid var(--green);
      color: var(--green);
      text-shadow: 0 0 20px rgba(0, 255, 65, 0.8);
    }

    .result-lose {
      background: rgba(255, 0, 85, 0.2);
      border: 3px solid var(--red);
      color: var(--red);
      text-shadow: 0 0 20px rgba(255, 0, 85, 0.8);
    }

    .result-push {
      background: rgba(255, 170, 0, 0.2);
      border: 3px solid var(--yellow);
      color: var(--yellow);
      text-shadow: 0 0 20px rgba(255, 170, 0, 0.8);
    }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      h1 {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-cards">
      <div class="loading-card"></div>
      <div class="loading-card"></div>
    </div>
    <div class="loading-text">EMBARALHANDO...</div>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper">
    <div class="container">
      <h1>üÉè BLACKJACK 21 üÉè</h1>
      <p class="subtitle">[ ENFRENTE A CASA - CHEGUE EM 21 ]</p>

      <div class="top-bar">
        <button class="btn btn-back" onclick="window.location.href='casino_menu.html'">
          ‚Üê VOLTAR AO MENU
        </button>
        <div style="font-family: 'Orbitron', monospace; font-size: 1.2em; color: var(--green);">
          <span id="statusIndicator">‚óè</span> <span id="statusText">CONECTANDO...</span>
        </div>
        <button class="btn btn-start" id="startGameBtn" onclick="startGame()">
          ‚ñ∂ INICIAR JOGO
        </button>
      </div>

      <div class="main-grid">
        <!-- Players Panel -->
        <div class="card">
          <div class="card-title">üë• JOGADORES</div>
          <div class="player-list" id="playerList">
            <!-- Players will be added here -->
          </div>
          <button class="btn add-player-btn" id="addPlayerBtn" onclick="addPlayer()">
            ‚ûï ADICIONAR JOGADOR
          </button>
        </div>

        <!-- Game Area -->
        <div>
          <!-- Betting Panel -->
          <div class="betting-panel" id="bettingPanel" style="display: none;">
            <div class="card-title" style="border-color: var(--yellow); color: var(--yellow);">üí∞ FAZER APOSTA</div>
            <div id="currentPlayerBetting"></div>
          </div>

          <!-- Dealer Section -->
          <div class="dealer-section">
            <div class="section-title">üè¶ CASA (DEALER)</div>
            <div class="score-display" id="dealerScore">PONTUA√á√ÉO: --</div>
            <div class="cards-display" id="dealerCards">
              <!-- Dealer cards here -->
            </div>
          </div>

          <!-- Player Section -->
          <div class="player-section">
            <div class="section-title" id="currentPlayerTitle">üéÆ JOGADOR</div>
            <div class="score-display" id="playerScore">PONTUA√á√ÉO: --</div>
            <div class="cards-display" id="playerCards">
              <!-- Player cards here -->
            </div>
            <div class="actions" id="gameActions" style="display: none;">
              <button class="btn btn-hit" id="hitBtn" onclick="hit()">
                üëâ HIT (PUXAR CARTA)
              </button>
              <button class="btn btn-stand" id="standBtn" onclick="stand()">
                ‚úã STAND (PARAR)
              </button>
            </div>
          </div>

          <!-- Result Message -->
          <div id="resultMessage"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // MQTT Setup
    const MQTT_HOST = 'broker.hivemq.com';
    const MQTT_PORT = 8000;
    const clientId = 'franzininho-blackjack-' + Math.random().toString(16).slice(2, 10);
    const TOPIC_PLAYER_TURN = 'IFCE_caua/blackjack_turn';
    const TOPIC_GAME_RESULT = 'IFCE_caua/blackjack_result';
    
    let mqttClient;
    let players = [];
    let currentPlayerIndex = 0;
    let gameStarted = false;
    let dealer = { cards: [], score: 0 };
    let deck = [];

    // Player colors
    const playerColors = ['#ff0055', '#00ff41', '#0080ff', '#ffaa00', '#ff00ff'];

    // Card suits and values
    const suits = ['‚ô•', '‚ô¶', '‚ô£', '‚ô†'];
    const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

    // Initialize MQTT
    function initMQTT() {
      mqttClient = mqtt.connect(`ws://${MQTT_HOST}:${MQTT_PORT}/mqtt`);
      
      mqttClient.on('connect', () => {
        document.getElementById('statusText').textContent = 'ONLINE';
        document.getElementById('statusIndicator').style.color = 'var(--green)';
        console.log('MQTT Connected');
      });

      mqttClient.on('error', (err) => {
        console.error('MQTT Error:', err);
        document.getElementById('statusText').textContent = 'ERRO';
        document.getElementById('statusIndicator').style.color = 'var(--red)';
      });
    }

    // Create deck
    function createDeck() {
      deck = [];
      for (let suit of suits) {
        for (let value of values) {
          const isRed = suit === '‚ô•' || suit === '‚ô¶';
          deck.push({
            suit: suit,
            value: value,
            color: isRed ? 'red' : 'black',
            numericValue: getCardValue(value)
          });
        }
      }
      shuffleDeck();
    }

    function shuffleDeck() {
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
    }

    function getCardValue(value) {
      if (value === 'A') return 11;
      if (['J', 'Q', 'K'].includes(value)) return 10;
      return parseInt(value);
    }

    function drawCard() {
      if (deck.length === 0) {
        createDeck();
      }
      return deck.pop();
    }

    function calculateScore(cards) {
      let score = 0;
      let aces = 0;

      for (let card of cards) {
        score += card.numericValue;
        if (card.value === 'A') aces++;
      }

      // Adjust for aces
      while (score > 21 && aces > 0) {
        score -= 10;
        aces--;
      }

      return score;
    }

    // Add player
    function addPlayer() {
      if (players.length >= 5) {
        alert('M√ÅXIMO DE 5 JOGADORES!');
        return;
      }
      if (gameStarted) {
        alert('N√ÉO √â POSS√çVEL ADICIONAR JOGADORES DURANTE O JOGO!');
        return;
      }

      const playerName = prompt('Digite o nome do jogador:', `PLAYER ${players.length + 1}`);
      if (!playerName || playerName.trim() === '') {
        return;
      }

      const player = {
        id: players.length + 1,
        name: playerName.trim().toUpperCase(),
        chips: 200,
        color: playerColors[players.length],
        cards: [],
        score: 0,
        bet: 0,
        status: 'waiting' // waiting, betting, playing, done
      };

      players.push(player);
      updatePlayersList();

      if (players.length === 5) {
        document.getElementById('addPlayerBtn').disabled = true;
        document.getElementById('addPlayerBtn').style.opacity = '0.3';
      }
    }

    // Update players list
    function updatePlayersList() {
      const list = document.getElementById('playerList');
      list.innerHTML = '';

      players.forEach((player, index) => {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.style.borderColor = player.color;
        if (index === currentPlayerIndex && gameStarted) {
          card.classList.add('active');
        }
        
        card.innerHTML = `
          <div class="player-name" style="color: ${player.color}">${player.name}</div>
          <div class="player-chips" style="color: ${player.color}">üí∞ ${player.chips}</div>
          ${player.bet > 0 ? `<div class="player-bet">Aposta: ${player.bet}</div>` : ''}
          ${player.status !== 'waiting' ? `<div class="player-bet">Status: ${player.status}</div>` : ''}
        `;
        list.appendChild(card);
      });
    }

    // Start game
    function startGame() {
      if (players.length === 0) {
        alert('ADICIONE PELO MENOS 1 JOGADOR!');
        return;
      }

      gameStarted = true;
      currentPlayerIndex = 0;
      createDeck();
      
      document.getElementById('startGameBtn').disabled = true;
      document.getElementById('addPlayerBtn').disabled = true;
      
      // Reset all players
      players.forEach(p => {
        p.cards = [];
        p.score = 0;
        p.bet = 0;
        p.status = 'betting';
      });

      dealer = { cards: [], score: 0 };
      
      document.getElementById('resultMessage').innerHTML = '';
      document.getElementById('dealerCards').innerHTML = '';
      document.getElementById('playerCards').innerHTML = '';
      document.getElementById('dealerScore').textContent = 'PONTUA√á√ÉO: --';
      document.getElementById('playerScore').textContent = 'PONTUA√á√ÉO: --';

      updatePlayersList();
      showBettingPanel();
    }

    // Show betting panel
    function showBettingPanel() {
      const player = players[currentPlayerIndex];
      const panel = document.getElementById('bettingPanel');
      panel.style.display = 'block';

      // Send MQTT - player turn
      if (mqttClient && mqttClient.connected) {
        const rgbColor = hexToRgb(player.color);
        mqttClient.publish('IFCE_caua/led_control', rgbColor);
        mqttClient.publish(TOPIC_PLAYER_TURN, player.name);
        mqttClient.publish('IFCE_caua/display_msg', `${player.name} - Aposte!`);
        mqttClient.publish('IFCE_caua/buzzer_control', '800'); // Beep
      }

      document.getElementById('currentPlayerBetting').innerHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
          <div style="font-size: 1.5em; color: ${player.color}; font-family: 'Orbitron', monospace; font-weight: 900;">
            ${player.name}
          </div>
          <div style="font-size: 1.3em; color: ${player.color}; font-family: 'Orbitron', monospace;">
            üí∞ ${player.chips} FICHAS
          </div>
        </div>

        <div class="bet-input-group">
          <label>Valor da Aposta (M√≠nimo 10):</label>
          <input type="number" id="betAmount" min="10" max="${player.chips}" step="10" value="10" />
        </div>

        <div class="quick-bet-btns">
          <button class="quick-bet-btn" onclick="setQuickBet(10)">10</button>
          <button class="quick-bet-btn" onclick="setQuickBet(25)">25</button>
          <button class="quick-bet-btn" onclick="setQuickBet(50)">50</button>
          <button class="quick-bet-btn" onclick="setQuickBet(100)">100</button>
        </div>

        <button class="btn btn-start" onclick="placeBet()" style="width: 100%; margin-top: 15px;">
          üíé CONFIRMAR APOSTA
        </button>
      `;
    }

    function setQuickBet(amount) {
      const player = players[currentPlayerIndex];
      const input = document.getElementById('betAmount');
      if (input) input.value = Math.min(amount, player.chips);
    }

    function placeBet() {
      const amount = parseInt(document.getElementById('betAmount').value);
      const player = players[currentPlayerIndex];

      if (amount < 10) {
        alert('APOSTA M√çNIMA: 10 FICHAS!');
        return;
      }

      if (amount > player.chips) {
        alert('FICHAS INSUFICIENTES!');
        return;
      }

      player.bet = amount;
      player.chips -= amount;
      player.status = 'playing';
      
      updatePlayersList();
      document.getElementById('bettingPanel').style.display = 'none';

      // Start dealing
      dealInitialCards();
    }

    function dealInitialCards() {
      const player = players[currentPlayerIndex];
      
      // Deal 2 cards to player
      player.cards.push(drawCard());
      setTimeout(() => {
        player.cards.push(drawCard());
        player.score = calculateScore(player.cards);
        displayPlayerCards();
        
        // Deal 2 cards to dealer (1 hidden)
        if (currentPlayerIndex === 0) {
          dealer.cards = [];
          dealer.cards.push(drawCard());
          dealer.cards.push(drawCard());
          displayDealerCards(true); // Hide second card
        } else {
          displayDealerCards(true);
        }

        checkPlayerBlackjack();
      }, 300);
    }

    function checkPlayerBlackjack() {
      const player = players[currentPlayerIndex];
      if (player.score === 21) {
        alert(`${player.name} FEZ BLACKJACK! üéâ`);
        stand();
      } else {
        document.getElementById('gameActions').style.display = 'flex';
        document.getElementById('currentPlayerTitle').textContent = `üéÆ ${player.name}`;
      }
    }

    function displayPlayerCards() {
      const player = players[currentPlayerIndex];
      const container = document.getElementById('playerCards');
      container.innerHTML = '';

      player.cards.forEach(card => {
        const cardEl = createCardElement(card);
        container.appendChild(cardEl);
      });

      document.getElementById('playerScore').textContent = `PONTUA√á√ÉO: ${player.score}`;
    }

    function displayDealerCards(hideSecond = false) {
      const container = document.getElementById('dealerCards');
      container.innerHTML = '';

      dealer.cards.forEach((card, index) => {
        let cardEl;
        if (hideSecond && index === 1) {
          cardEl = createCardElement(card, true);
        } else {
          cardEl = createCardElement(card);
        }
        container.appendChild(cardEl);
      });

      if (hideSecond) {
        document.getElementById('dealerScore').textContent = `PONTUA√á√ÉO: ${dealer.cards[0].numericValue}`;
      } else {
        dealer.score = calculateScore(dealer.cards);
        document.getElementById('dealerScore').textContent = `PONTUA√á√ÉO: ${dealer.score}`;
      }
    }

    function createCardElement(card, hidden = false) {
      const cardEl = document.createElement('div');
      cardEl.className = `playing-card ${card.color}`;
      
      if (hidden) {
        cardEl.classList.add('hidden');
      } else {
        cardEl.innerHTML = `
          <div class="card-value">${card.value}</div>
          <div class="card-suit">${card.suit}</div>
        `;
      }

      return cardEl;
    }

    function hit() {
      const player = players[currentPlayerIndex];
      const newCard = drawCard();
      player.cards.push(newCard);
      player.score = calculateScore(player.cards);
      
      displayPlayerCards();

      // Play card sound
      playCardSound();

      if (player.score > 21) {
        // Busted!
        alert(`${player.name} ESTOUROU! üí•`);
        player.status = 'busted';
        updatePlayersList();
        document.getElementById('gameActions').style.display = 'none';
        nextPlayer();
      } else if (player.score === 21) {
        alert(`${player.name} CHEGOU EM 21! üéØ`);
        stand();
      }
    }

    function stand() {
      const player = players[currentPlayerIndex];
      player.status = 'standing';
      updatePlayersList();
      document.getElementById('gameActions').style.display = 'none';
      
      nextPlayer();
    }

    function nextPlayer() {
      currentPlayerIndex++;
      
      if (currentPlayerIndex < players.length) {
        setTimeout(() => {
          showBettingPanel();
        }, 1000);
      } else {
        // All players done, dealer plays
        setTimeout(() => {
          dealerPlay();
        }, 1000);
      }
    }

    function dealerPlay() {
      document.getElementById('currentPlayerTitle').textContent = 'üéÆ DEALER JOGANDO...';
      displayDealerCards(false); // Reveal hidden card

      // Dealer must hit until 17 or higher
      const dealerHit = setInterval(() => {
        dealer.score = calculateScore(dealer.cards);
        
        if (dealer.score < 17) {
          dealer.cards.push(drawCard());
          displayDealerCards(false);
          playCardSound();
        } else {
          clearInterval(dealerHit);
          setTimeout(() => {
            determineWinners();
          }, 1000);
        }
      }, 1000);
    }

    function determineWinners() {
      dealer.score = calculateScore(dealer.cards);
      const dealerBusted = dealer.score > 21;
      
      let results = '';

      players.forEach(player => {
        if (player.status === 'busted') {
          // Player busted - lose bet
          results += `<div class="result-lose">${player.name} PERDEU (ESTOUROU)</div>`;
        } else {
          if (dealerBusted) {
            // Dealer busted - player wins
            const winAmount = player.bet * 2;
            player.chips += winAmount;
            results += `<div class="result-win">${player.name} GANHOU +${winAmount} üéâ</div>`;
            playWinSound();
          } else if (player.score > dealer.score) {
            // Player wins
            const winAmount = player.bet * 2;
            player.chips += winAmount;
            results += `<div class="result-win">${player.name} GANHOU +${winAmount} üéâ</div>`;
            playWinSound();
          } else if (player.score === dealer.score) {
            // Push - return bet
            player.chips += player.bet;
            results += `<div class="result-push">${player.name} EMPATE (APOSTA DEVOLVIDA)</div>`;
          } else {
            // Dealer wins
            results += `<div class="result-lose">${player.name} PERDEU</div>`;
          }
        }
      });

      document.getElementById('resultMessage').innerHTML = results;
      updatePlayersList();

      // Send results via MQTT
      if (mqttClient && mqttClient.connected) {
        mqttClient.publish(TOPIC_GAME_RESULT, `Dealer: ${dealer.score}`);
        mqttClient.publish('IFCE_caua/display_msg', 'Rodada Finalizada!');
      }

      // Check if any player can continue
      setTimeout(() => {
        const activePlayers = players.filter(p => p.chips >= 10);
        if (activePlayers.length === 0) {
          alert('JOGO FINALIZADO! TODOS OS JOGADORES SEM FICHAS!');
          resetGame();
        } else {
          if (confirm('JOGAR OUTRA RODADA?')) {
            nextRound();
          } else {
            resetGame();
          }
        }
      }, 3000);
    }

    function nextRound() {
      currentPlayerIndex = 0;
      createDeck();
      
      players = players.filter(p => p.chips >= 10);
      players.forEach(p => {
        p.cards = [];
        p.score = 0;
        p.bet = 0;
        p.status = 'betting';
      });

      dealer = { cards: [], score: 0 };
      
      document.getElementById('resultMessage').innerHTML = '';
      document.getElementById('dealerCards').innerHTML = '';
      document.getElementById('playerCards').innerHTML = '';
      document.getElementById('dealerScore').textContent = 'PONTUA√á√ÉO: --';
      document.getElementById('playerScore').textContent = 'PONTUA√á√ÉO: --';
      document.getElementById('currentPlayerTitle').textContent = 'üéÆ JOGADOR';

      updatePlayersList();
      showBettingPanel();
    }

    function resetGame() {
      players = [];
      currentPlayerIndex = 0;
      gameStarted = false;
      
      document.getElementById('startGameBtn').disabled = false;
      document.getElementById('addPlayerBtn').disabled = false;
      document.getElementById('addPlayerBtn').style.opacity = '1';
      document.getElementById('bettingPanel').style.display = 'none';
      document.getElementById('gameActions').style.display = 'none';
      document.getElementById('resultMessage').innerHTML = '';
      document.getElementById('dealerCards').innerHTML = '';
      document.getElementById('playerCards').innerHTML = '';
      document.getElementById('dealerScore').textContent = 'PONTUA√á√ÉO: --';
      document.getElementById('playerScore').textContent = 'PONTUA√á√ÉO: --';
      document.getElementById('currentPlayerTitle').textContent = 'üéÆ JOGADOR';
      
      updatePlayersList();
    }

    // Sound functions
    function playCardSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      
      osc.connect(gain);
      gain.connect(audioContext.destination);
      
      osc.type = 'sine';
      osc.frequency.value = 600;
      gain.gain.value = 0.1;
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      osc.start();
      osc.stop(audioContext.currentTime + 0.1);
    }

    function playWinSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const notes = [523, 659, 784, 1047];
      
      notes.forEach((freq, index) => {
        setTimeout(() => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          
          osc.connect(gain);
          gain.connect(audioContext.destination);
          
          osc.type = 'sine';
          osc.frequency.value = freq;
          gain.gain.value = 0.2;
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
          
          osc.start();
          osc.stop(audioContext.currentTime + 0.3);
        }, index * 100);
      });
    }

    function playEntranceSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const notes = [330, 392, 494, 659]; // E, G, B, E
      
      notes.forEach((freq, index) => {
        setTimeout(() => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          
          osc.connect(gain);
          gain.connect(audioContext.destination);
          
          osc.type = 'sine';
          osc.frequency.value = freq;
          gain.gain.value = 0.2;
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
          
          osc.start();
          osc.stop(audioContext.currentTime + 0.3);
        }, index * 100);
      });
    }

    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? `${parseInt(result[1], 16)},${parseInt(result[2], 16)},${parseInt(result[3], 16)}` : '0,255,0';
    }

    // Cleanup ao sair da p√°gina
    window.addEventListener('beforeunload', () => {
      if (mqttClient && mqttClient.connected) {
        mqttClient.publish('IFCE_caua/led_control', '0,0,0');
        mqttClient.publish('IFCE_caua/buzzer_control', '0');
        mqttClient.publish('IFCE_caua/display_msg', 'Casino Menu');
      }
    });

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      initMQTT();
      updatePlayersList();
      playEntranceSound();

      setTimeout(() => {
        const loadingScreen = document.getElementById('loadingScreen');
        loadingScreen.classList.add('hidden');
        setTimeout(() => {
          loadingScreen.remove();
        }, 500);
      }, 2000);
    });
  </script>
</body>
</html>
